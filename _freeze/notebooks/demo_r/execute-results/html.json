{
  "hash": "fb554deed3edad95eb80b10d2ce0bb5a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Building Surrogate Models with {midr}\"\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# data manipuration\nlibrary(arrow)\n\n# predictive modeling\nlibrary(gam)\nlibrary(lightgbm)\n\n# surrogate modeling\nlibrary(midr)\nlibrary(midnight)\n\n# visualization\nlibrary(ggplot2)\nlibrary(gridExtra)\n\n# load training and testin datasets\ntrain <- read_parquet(\"../data/train.parquet\")\ntest  <- read_parquet(\"../data/test.parquet\")\ntrain <- train[sample(nrow(train), 50000), ]\n```\n:::\n\n\n## GAM: An Interpretable Model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_gam <- gam(\n  Frequency ~ s(VehPower) + s(VehAge) + s(DrivAge) + s(LogDensity) +\n              VehBrand + VehGas + Region,\n  data = train,\n  weights = Exposure,\n  family = quasipoisson(link = \"log\")\n)\nsummary(fit_gam)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall: gam(formula = Frequency ~ s(VehPower) + s(VehAge) + s(DrivAge) + \n    s(LogDensity) + VehBrand + VehGas + Region, family = quasipoisson(link = \"log\"), \n    data = train, weights = Exposure)\nDeviance Residuals:\n    Min      1Q  Median      3Q     Max \n-0.7767 -0.3375 -0.2522 -0.1401 10.8162 \n\n(Dispersion Parameter for quasipoisson family taken to be 2.0443)\n\n    Null Deviance: 12885.06 on 49999 degrees of freedom\nResidual Deviance: 12550.42 on 49971 degrees of freedom\nAIC: NA \n\nNumber of Local Scoring Iterations: NA \n\nAnova for Parametric Effects\n                 Df Sum Sq Mean Sq F value    Pr(>F)    \ns(VehPower)       1     18  17.535  8.5774  0.003405 ** \ns(VehAge)         1      8   7.891  3.8598  0.049462 *  \ns(DrivAge)        1     88  87.779 42.9388 5.703e-11 ***\ns(LogDensity)     1     81  80.666 39.4593 3.377e-10 ***\nVehBrand          5     26   5.297  2.5913  0.023804 *  \nVehGas            1      7   6.568  3.2129  0.073066 .  \nRegion            6     12   1.976  0.9667  0.445957    \nResiduals     49971 102155   2.044                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nAnova for Nonparametric Effects\n              Npar Df  Npar F     Pr(F)    \n(Intercept)                                \ns(VehPower)         3  0.6279   0.59689    \ns(VehAge)           3  2.6376   0.04786 *  \ns(DrivAge)          3 11.5076 1.545e-07 ***\ns(LogDensity)       3  1.6039   0.18612    \nVehBrand                                   \nVehGas                                     \nRegion                                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n### Surrogate Modeling for GAM\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmid_gam <- interpret(\n  Frequency ~ VehPower + VehAge + DrivAge + LogDensity +\n              VehBrand + VehGas + Region,\n  train,\n  weights = Exposure,\n  link = \"log\",\n  model = fit_gam\n)\nsummary(mid_gam)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\ninterpret(formula = Frequency ~ VehPower + VehAge + DrivAge +\n LogDensity + VehBrand + VehGas + Region, data = train, model = fit_gam,\n weights = Exposure, link = \"log\")\n\nLink: log\n\nUninterpreted Variation Ratio:\n   working   response \n0.00027850 0.00043825 \n\nWorking Residuals:\n       Min         1Q     Median         3Q        Max \n-0.0620208 -0.0012274 -0.0000731  0.0010569  0.0493120 \n\nEncoding:\n           main.effect\nVehPower     linear(9)\nVehAge      linear(18)\nDrivAge     linear(25)\nLogDensity  linear(25)\nVehBrand     factor(6)\nVehGas       factor(2)\nRegion       factor(7)\n```\n\n\n:::\n:::\n\n\n### Evaluation of Surrogate Model Fidelity\n\nTypically, the R-squared metrics is used to measure the fidelity of surrogate models.\n\nIn the summary of the fitted MID model, $1 - R^s$ is referred as **(Working) Uninterpreted Variation Ratio**.\n\nWe can confirm how the predictions of the MID surrogate replicates the predictions from the original GAM on the testing dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_midr(\"xy\"))\npreds_df <- data.frame(\n  fit_gam = predict(fit_gam, test, type = \"response\"),\n  mid_gam = predict(mid_gam, test, type = \"response\")\n) \nsample_id <- sample(nrow(preds_df), 2000)\np <- ggplot(preds_df[sample_id, ])\ngrid.arrange(\n  nrow = 1,\n  p +\n    geom_point(aes(log(fit_gam), log(mid_gam))) +\n    labs(x = \"GAM\", y = \"MID Surrogate\",\n         title = \"Model Fidelity\", subtitle = \"Linear predictor\"),\n  p +\n    geom_point(aes(log(fit_gam), log(mid_gam))) +\n    labs(x = \"GAM\", y = \"MID Surrogate\",\n         title = \"\", subtitle = \"Prediction in the original scale\")\n)\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n### Visualization of Effects\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar.midr(mfrow = c(2, 4))\ntermplot(fit_gam)\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar.midr(mfrow = c(2, 4))\nmid.plots(mid_gam, engine = \"graphics\", ylab = \"Partial Effect\")\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar.midr(mar = c(1,1,1,1))\npersp(mid_gam, \"LogDensity:DrivAge\", theta = 225, phi = 40, shade = .5)\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### Feature Importance\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimp_gam <- mid.importance(mid_gam, data = train, max.nrow = 2000)\ngrid.arrange(\n  nrow = 1,\n  ggmid(imp_gam, fill = \"steelblue\") +\n    labs(title = \"Feature Importance\",\n         subtitle = \"Average absolute effect per feature\"),\n  ggmid(imp_gam, type = \"beeswarm\", theme = \"mako@div\") +\n    labs(title = \"\",\n         subtitle = \"Distribution of effect per feature\") +\n    theme(legend.position = \"none\")\n)\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n### Conditional Expectation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nice_gam_link <- mid.conditional(mid_gam, type = \"link\", variable = \"DrivAge\")\nice_gam <- mid.conditional(mid_gam, variable = \"DrivAge\")\ngrid.arrange(\n  nrow = 1,\n  ggmid(ice_gam_link, var.color = LogDensity) +\n    theme(legend.position = \"bottom\") +\n    labs(y = \"Linear Predictor\",\n         title = \"Conditional Expectation\",\n         subtitle = \"Change in linear predictor\"),\n  ggmid(ice_gam, type = \"centered\", var.color = LogDensity) +\n    theme(legend.position = \"bottom\") +\n    labs(y = \"Prediction\", title = \"\",\n         subtitle = \"Centered change in original scale\")\n)\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n### Additive Feature Attribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\nrow_ids <- sample(nrow(train), 4)\nbd_list <- lapply(\n  row_ids,\n  function(x) {\n    res <- mid.breakdown(mid_gam, train, row = x, format = \"%.6s\")\n    structure(res, row_id = x)\n  }\n)\nbd_plots <- lapply(\n  bd_list, function(x) {\n    label <- paste0(\"Row ID: \", attr(x, \"row_id\"))\n    ggmid(x, theme = \"shap\") +\n      labs(x = \"Linear Predictor\", subtitle = label) +\n      theme(legend.position = \"none\")\n  }\n)\ngrid.arrange(grobs = bd_plots)\n```\n\n::: {.cell-output-display}\n![](demo_r_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## LightGBM: A Black-Box Model with High Performance\n\n",
    "supporting": [
      "demo_r_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}